<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <!-- Unified Cloud Sync -->
    <script src="https://thelightparkops.com/shared/cloud-sync.js"></script>
    <title>Maintenance Tracker | The Light Park</title>
  
  <!-- Supabase Cloud Sync -->
  <script>
    const SUPABASE_URL = 'https://gwjtfcrgpxclixonogpe.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd3anRmY3JncHhjbGl4b25vZ3BlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzMzQzOTUsImV4cCI6MjA4NTkxMDM5NX0.qM1-_VA1Dsx_nsWkeoAJvNWNgSuuwApPBGoJU32X3-I';
    const APP_NAME = 'maintenance_tracker';
    
    window.CloudSync = {
      online: navigator.onLine,
      async save(key, data) {
        if (!this.online) return { synced: false };
        try {
          const existing = await fetch(
            `${SUPABASE_URL}/rest/v1/app_data?app_data=eq.${APP_NAME}&data_key=eq.${key}&select=id`,
            { headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` }}
          ).then(r => r.json());
          
          const method = existing.length > 0 ? 'PATCH' : 'POST';
          const url = existing.length > 0 
            ? `${SUPABASE_URL}/rest/v1/app_data?id=eq.${existing[0].id}`
            : `${SUPABASE_URL}/rest/v1/app_data`;
          const body = existing.length > 0 
            ? { data, created_at: new Date().toISOString() }
            : { app_data: APP_NAME, data_key: key, data };
          
          await fetch(url, {
            method,
            headers: {
              'apikey': SUPABASE_KEY,
              'Authorization': `Bearer ${SUPABASE_KEY}`,
              'Content-Type': 'application/json',
              'Prefer': 'return=minimal'
            },
            body: JSON.stringify(body)
          });
          return { synced: true };
        } catch (err) {
          console.error('[CloudSync] Save failed:', err);
          return { synced: false };
        }
      },
      async load(key) {
        if (!this.online) return null;
        try {
          const result = await fetch(
            `${SUPABASE_URL}/rest/v1/app_data?app_data=eq.${APP_NAME}&data_key=eq.${key}&select=data`,
            { headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` }}
          ).then(r => r.json());
          return result.length > 0 ? result[0].data : null;
        } catch (err) {
          return null;
        }
      }
    };
    window.addEventListener('online', () => CloudSync.online = true);
    window.addEventListener('offline', () => CloudSync.online = false);
  </script>
  
  <style>
    :root {
      --bg: #0B0D14;
      --surface: #12151F;
      --surface2: #1a1e2e;
      --border: #2a2f42;
      --text: #f0f0f5;
      --text-dim: #8888a0;
      --purple: #a855f7;
      --teal: #06d6a0;
      --pink: #ff4fd8;
      --green: #22c55e;
      --orange: #f97316;
      --blue: #3b82f6;
      --red: #ef4444;
      --yellow: #eab308;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }
    
    .header {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 16px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .header h1 { font-size: 22px; font-weight: 800; }
    .btn {
      padding: 10px 18px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      font-size: 14px;
    }
    .btn-primary { background: var(--purple); color: white; }
    .btn-secondary { background: var(--surface2); border: 1px solid var(--border); color: var(--text); }
    
    .container { padding: 20px; }
    
    /* Stats */
    .stats-row {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }
    .stat-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
    }
    .stat-value { font-size: 36px; font-weight: 800; }
    .stat-label { font-size: 13px; color: var(--text-dim); margin-top: 4px; }
    .stat-open .stat-value { color: var(--red); }
    .stat-progress .stat-value { color: var(--orange); }
    .stat-parts .stat-value { color: var(--yellow); }
    .stat-resolved .stat-value { color: var(--green); }
    
    /* Filters */
    .filters {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .filters select, .filters input {
      padding: 10px 14px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-size: 14px;
    }
    .filters input { flex: 1; min-width: 200px; }
    
    /* Tickets List */
    .tickets-list { display: flex; flex-direction: column; gap: 12px; }
    
    .ticket-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      display: grid;
      grid-template-columns: auto 1fr auto;
      gap: 16px;
      align-items: center;
    }
    .ticket-card:hover { border-color: var(--purple); }
    
    .ticket-priority {
      width: 8px;
      height: 60px;
      border-radius: 4px;
    }
    .priority-high { background: var(--red); }
    .priority-medium { background: var(--orange); }
    .priority-low { background: var(--yellow); }
    
    .ticket-info { flex: 1; }
    .ticket-title { font-weight: 700; font-size: 15px; margin-bottom: 4px; }
    .ticket-meta { font-size: 12px; color: var(--text-dim); display: flex; gap: 16px; flex-wrap: wrap; }
    .ticket-desc {
      font-size: 13px;
      color: var(--text-dim);
      margin-top: 8px;
      padding: 8px 12px;
      background: var(--surface2);
      border-radius: 6px;
    }
    
    .ticket-status { text-align: right; }
    .status-badge {
      padding: 6px 14px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 600;
      display: inline-block;
      margin-bottom: 6px;
    }
    .status-open { background: rgba(239,68,68,0.2); color: var(--red); }
    .status-progress { background: rgba(249,115,22,0.2); color: var(--orange); }
    .status-parts { background: rgba(234,179,8,0.2); color: var(--yellow); }
    .status-resolved { background: rgba(34,197,94,0.2); color: var(--green); }
    
    .ticket-actions {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }
    .ticket-btn {
      padding: 6px 12px;
      font-size: 12px;
      border-radius: 6px;
      cursor: pointer;
      border: 1px solid var(--border);
      background: var(--surface2);
      color: var(--text-dim);
    }
    .ticket-btn:hover { border-color: var(--purple); color: var(--text); }
    
    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.8);
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }
    .modal.show { display: flex; }
    .modal-content {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      width: 100%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
    }
    .modal-title { font-size: 20px; font-weight: 700; margin-bottom: 20px; }
    .form-group { margin-bottom: 16px; }
    .form-group label { display: block; font-size: 13px; color: var(--text-dim); margin-bottom: 6px; }
    .form-group input, .form-group select, .form-group textarea {
      width: 100%;
      padding: 12px;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-size: 14px;
    }
    .form-group textarea { min-height: 80px; resize: vertical; }
    .modal-actions { display: flex; gap: 12px; margin-top: 20px; }
    .modal-actions .btn { flex: 1; }
    
    @media (max-width: 768px) {
      .stats-row { grid-template-columns: repeat(2, 1fr); }
      .ticket-card { grid-template-columns: auto 1fr; }
      .ticket-status { grid-column: 2; }
    }
  </style>
  <script src="supabase-sync.js"></script>
</head>
<body>
  <div id="splash" style="position:fixed;top:0;left:0;width:100%;height:100%;background:#0B0D14;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9999;transition:opacity 0.4s;">
    <div style="font-size:64px;margin-bottom:16px;">üîß</div>
    <div style="font-size:24px;font-weight:700;background:linear-gradient(135deg,#a855f7,#06d6a0);-webkit-background-clip:text;-webkit-text-fill-color:transparent;">Maintenance</div>
    <div style="color:#8888a0;margin-top:8px;">Loading...</div>
  </div>
  <script>setTimeout(()=>{const s=document.getElementById("splash");if(s){s.style.opacity="0";setTimeout(()=>s.style.display="none",400);}},1500);</script>
  <div class="header" style="position: relative; padding-top: 50px;">
      <a href="https://thelightparkops.com" style="position: absolute; top: 20px; left: 20px; color: #a855f7; text-decoration: none; font-size: 14px; font-weight: 600; display: flex; align-items: center; gap: 6px; transition: all 0.2s; z-index: 10;" onmouseover="this.style.color='#06d6a0'" onmouseout="this.style.color='#a855f7'">
        ‚Üê Dashboard
      </a>
    <h1>üîß Maintenance Tracker</h1>
    <button class="btn btn-primary" onclick="openModal()">‚ûï New Ticket</button>
  </div>
  
  <div class="container">
    <div class="stats-row">
      <div class="stat-card stat-open">
        <div class="stat-value" id="statOpen">5</div>
        <div class="stat-label">Open</div>
      </div>
      <div class="stat-card stat-progress">
        <div class="stat-value" id="statProgress">3</div>
        <div class="stat-label">In Progress</div>
      </div>
      <div class="stat-card stat-parts">
        <div class="stat-value" id="statParts">2</div>
        <div class="stat-label">Waiting Parts</div>
      </div>
      <div class="stat-card stat-resolved">
        <div class="stat-value" id="statResolved">24</div>
        <div class="stat-label">Resolved (This Week)</div>
      </div>
    </div>
    
    <div class="filters">
      <input type="text" placeholder="Search props..." id="searchInput">
      <select id="filterStatus">
        <option value="">All Status</option>
        <option value="open">Open</option>
        <option value="progress">In Progress</option>
        <option value="parts">Waiting Parts</option>
        <option value="resolved">Resolved</option>
      </select>
      <select id="filterVenue">
        <option value="">All Venues</option>
        <option value="katy">Katy</option>
        <option value="spring">Spring</option>
        <option value="selma">Selma</option>
        <option value="missions">Missions</option>
        <option value="arlington">Arlington</option>
        <option value="frisco">Frisco</option>
        <option value="round-rock">Round Rock</option>
        <option value="okc">Oklahoma City</option>
      </select>
      <select id="filterPriority">
        <option value="">All Priority</option>
        <option value="high">üî¥ High</option>
        <option value="medium">üü† Medium</option>
        <option value="low">üü° Low</option>
      </select>
    </div>
    
    <div class="tickets-list" id="ticketsList">
      <!-- Ticket 1 -->
      <div class="ticket-card">
        <div class="ticket-priority priority-high"></div>
        <div class="ticket-info">
          <div class="ticket-title">Gnome B #7 ‚Äî Controller Failure</div>
          <div class="ticket-meta">
            <span>üìç Katy</span>
            <span>‚è∞ 2h ago</span>
            <span>üë§ Eddie M.</span>
          </div>
          <div class="ticket-desc">Controller not responding. LED status light off. Power confirmed OK. Need replacement FPP unit.</div>
        </div>
        <div class="ticket-status">
          <div class="status-badge status-progress">In Progress</div>
          <div class="ticket-actions">
            <button class="ticket-btn" onclick="updateTicket(1)">Update</button>
            <button class="ticket-btn" onclick="resolveTicket(1)">Resolve</button>
          </div>
        </div>
      </div>
      
      <!-- Ticket 2 -->
      <div class="ticket-card">
        <div class="ticket-priority priority-high"></div>
        <div class="ticket-info">
          <div class="ticket-title">RGB Tunnel Section 3 ‚Äî Dead Pixels</div>
          <div class="ticket-meta">
            <span>üìç Spring</span>
            <span>‚è∞ 5h ago</span>
            <span>üë§ Jake T.</span>
          </div>
          <div class="ticket-desc">~20 dead pixels in middle section. Likely water damage from yesterday's rain. Need replacement string.</div>
        </div>
        <div class="ticket-status">
          <div class="status-badge status-parts">Waiting Parts</div>
          <div class="ticket-actions">
            <button class="ticket-btn" onclick="updateTicket(2)">Update</button>
            <button class="ticket-btn" onclick="resolveTicket(2)">Resolve</button>
          </div>
        </div>
      </div>
      
      <!-- Ticket 3 -->
      <div class="ticket-card">
        <div class="ticket-priority priority-medium"></div>
        <div class="ticket-info">
          <div class="ticket-title">Reindeer C #3 ‚Äî Weak WiFi Signal</div>
          <div class="ticket-meta">
            <span>üìç Katy</span>
            <span>‚è∞ 1d ago</span>
            <span>üë§ Unassigned</span>
          </div>
          <div class="ticket-desc">Intermittent sync drops during show. Signal strength ~40%. May need external antenna or AP adjustment.</div>
        </div>
        <div class="ticket-status">
          <div class="status-badge status-open">Open</div>
          <div class="ticket-actions">
            <button class="ticket-btn" onclick="assignTicket(3)">Assign</button>
            <button class="ticket-btn" onclick="updateTicket(3)">Update</button>
          </div>
        </div>
      </div>
      
      <!-- Ticket 4 -->
      <div class="ticket-card">
        <div class="ticket-priority priority-low"></div>
        <div class="ticket-info">
          <div class="ticket-title">Gift Box Array ‚Äî Loose Connection</div>
          <div class="ticket-meta">
            <span>üìç Selma</span>
            <span>‚è∞ 2d ago</span>
            <span>üë§ Chris M.</span>
          </div>
          <div class="ticket-desc">Occasional flicker on box #4. Likely loose data connector. Low priority ‚Äî not visible during normal show.</div>
        </div>
        <div class="ticket-status">
          <div class="status-badge status-open">Open</div>
          <div class="ticket-actions">
            <button class="ticket-btn" onclick="updateTicket(4)">Update</button>
            <button class="ticket-btn" onclick="resolveTicket(4)">Resolve</button>
          </div>
        </div>
      </div>
      
      <!-- Resolved Ticket -->
      <div class="ticket-card" style="opacity: 0.7;">
        <div class="ticket-priority" style="background: var(--green);"></div>
        <div class="ticket-info">
          <div class="ticket-title">Mega Tree ‚Äî Power Supply Replacement</div>
          <div class="ticket-meta">
            <span>üìç Katy</span>
            <span>‚è∞ Resolved 3h ago</span>
            <span>üë§ Eddie M.</span>
          </div>
          <div class="ticket-desc">350W PSU failed. Replaced with spare. Back online and tested OK.</div>
        </div>
        <div class="ticket-status">
          <div class="status-badge status-resolved">‚úì Resolved</div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- New Ticket Modal -->
  <div class="modal" id="newTicketModal">
    <div class="modal-content">
      <div class="modal-title">‚ûï New Maintenance Ticket</div>
      
      <div class="form-group">
        <label>Prop Name / Location *</label>
        <input type="text" id="propName" placeholder="e.g., Gnome B #7, RGB Tunnel Section 3">
      </div>
      
      <div class="form-group">
        <label>Venue *</label>
        <select id="ticketVenue">
          <option value="">Select venue...</option>
          <option value="katy">Katy</option>
          <option value="spring">Spring</option>
          <option value="selma">Selma</option>
          <option value="missions">Missions</option>
          <option value="arlington">Arlington</option>
          <option value="frisco">Frisco</option>
          <option value="round-rock">Round Rock</option>
          <option value="okc">Oklahoma City</option>
        </select>
      </div>
      
      <div class="form-group">
        <label>Priority *</label>
        <select id="ticketPriority">
          <option value="high">üî¥ High ‚Äî Show-stopping issue</option>
          <option value="medium" selected>üü† Medium ‚Äî Visible but not critical</option>
          <option value="low">üü° Low ‚Äî Minor / cosmetic</option>
        </select>
      </div>
      
      <div class="form-group">
        <label>Issue Description *</label>
        <textarea id="ticketDesc" placeholder="Describe the problem, symptoms, and any troubleshooting already tried..."></textarea>
      </div>
      
      <div class="form-group">
        <label>Assign To</label>
        <select id="ticketAssign">
          <option value="">Unassigned</option>
          <option value="eddie">Eddie M.</option>
          <option value="jake">Jake T.</option>
          <option value="chris">Chris M.</option>
          <option value="mike">Mike R.</option>
        </select>
      </div>
      
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
        <button class="btn btn-primary" onclick="createTicket()">Create Ticket</button>
      </div>
    </div>
  </div>
  
  <script>
    function openModal() {
      document.getElementById('newTicketModal').classList.add('show');
    }
    
    function closeModal() {
      document.getElementById('newTicketModal').classList.remove('show');
    }
    
    function createTicket() {
      const prop = document.getElementById('propName').value.trim();
      const venue = document.getElementById('ticketVenue').value;
      const priority = document.getElementById('ticketPriority').value;
      const desc = document.getElementById('ticketDesc').value.trim();
      
      if (!prop || !venue || !desc) {
        alert('Please fill in all required fields');
        return;
      }
      
      alert(`‚úÖ Ticket Created!\n\nProp: ${prop}\nVenue: ${venue}\nPriority: ${priority}\n\nThe ticket has been added and will appear in the list.`);
      closeModal();
      
      // Clear form
      document.getElementById('propName').value = '';
      document.getElementById('ticketDesc').value = '';
    }
    
    function updateTicket(id) {
      const note = prompt('Add update note:');
      if (note) {
        alert(`Update added to ticket #${id}:\n\n"${note}"`);
      }
    }
    
    function resolveTicket(id) {
      if (confirm('Mark this ticket as resolved?')) {
        alert(`Ticket #${id} marked as resolved!`);
      }
    }
    
    function assignTicket(id) {
      const tech = prompt('Assign to (enter name):');
      if (tech) {
        alert(`Ticket #${id} assigned to ${tech}`);
      }
    }
    
    // Close modal on outside click
    document.getElementById('newTicketModal').addEventListener('click', (e) => {
      if (e.target.id === 'newTicketModal') closeModal();
    });
  </script>
</body>
</html>
